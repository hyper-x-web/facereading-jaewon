<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AI 관상가 - 당신의 운명</title>
    <!-- MediaPipe 라이브러리 로드 -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@700&display=swap');

        body {
            background-color: #1a1a1a;
            color: #f0f0f0;
            font-family: 'Nanum Myeongjo', serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            margin-top: 20px;
            color: #ffd700;
            text-shadow: 0 0 10px #b8860b;
            font-size: 2.5rem;
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            width: 90%;
            max-width: 1200px;
        }

        .video-container {
            position: relative;
            width: 480px;
            height: 360px;
            background: #000;
            border: 4px solid #b8860b;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
        }

        video {
            display: none; /* 비디오 요소 자체는 숨김 */
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1); /* 거울 모드 */
        }

        .result-panel {
            width: 400px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid #555;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }

        .loading-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.2rem;
            z-index: 10;
        }

        .fortune-item {
            margin-bottom: 20px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        .fortune-title {
            font-size: 1.2rem;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .fortune-desc {
            font-size: 1rem;
            line-height: 1.5;
            color: #ddd;
        }

        /* 반응형 */
        @media (max-width: 900px) {
            .container {
                flex-direction: column;
                align-items: center;
            }
            .video-container {
                width: 100%;
                max-width: 480px;
                height: auto;
                aspect-ratio: 4/3;
            }
            .result-panel {
                width: 100%;
                max-width: 480px;
            }
        }
    </style>
</head>
<body>

    <h1>AI 관상가</h1>
    <p style="color: #aaa;">카메라를 응시하면 실시간으로 관상을 분석합니다.</p>

    <div class="container">
        <!-- 카메라 화면 영역 -->
        <div class="video-container">
            <div id="loader" class="loading-text">신비한 힘을 모으는 중...<br>(카메라 권한을 허용해주세요)</div>
            <video id="input_video"></video>
            <canvas id="output_canvas"></canvas>
        </div>

        <!-- 결과 텍스트 영역 -->
        <div class="result-panel">
            <div id="results-content">
                <div style="text-align: center; color: #888; padding-top: 50px;">
                    얼굴을 인식하면 결과가 나타납니다.
                </div>
            </div>
        </div>
    </div>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const resultsDiv = document.getElementById('results-content');
        const loader = document.getElementById('loader');

        // 거리 계산 함수
        function getDistance(p1, p2) {
            return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
        }

        function onResults(results) {
            // 로딩 메시지 숨기기
            loader.style.display = 'none';

            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                const landmarks = results.multiFaceLandmarks[0];

                // 얼굴 그물망 그리기 (시각적 효과)
                drawConnectors(canvasCtx, landmarks, FACEMESH_TESSELATION, 
                              {color: '#C0C0C070', lineWidth: 1});

                // --- 관상 분석 로직 ---
                
                // 주요 좌표 (MediaPipe 기준)
                // 10:이마위, 152:턱끝, 9:미간위(눈썹중앙), 2:코밑
                const topHead = landmarks[10];
                const chin = landmarks[152];
                const eyebrowCenter = landmarks[9];
                const noseBottom = landmarks[2];

                // 전체 얼굴 길이 (높이)
                const faceHeight = getDistance(topHead, chin);

                // 1. 삼정(三停) 비율 계산
                const upperFace = getDistance(topHead, eyebrowCenter); // 상정 (초년)
                const middleFace = getDistance(eyebrowCenter, noseBottom); // 중정 (중년)
                const lowerFace = getDistance(noseBottom, chin); // 하정 (말년)

                // 2. 눈 (연애운)
                // 33:왼쪽눈꼬리, 133:왼쪽눈안쪽, 159:왼쪽눈위, 145:왼쪽눈아래
                const eyeWidth = getDistance(landmarks[33], landmarks[133]);
                const eyeHeight = getDistance(landmarks[159], landmarks[145]);
                const eyeRatio = eyeHeight / eyeWidth;

                // 3. 코 (금전운)
                // 49:왼쪽코끝, 279:오른쪽코끝 (콧볼 너비), 168:미간, 1:코끝(길이)
                const noseWidth = getDistance(landmarks[49], landmarks[279]);
                const noseLength = getDistance(landmarks[168], landmarks[1]);
                const noseRatio = noseWidth / noseLength;

                // 4. 인중 (자식운)
                // 2:코밑, 0:윗입술중앙
                const philtrum = getDistance(landmarks[2], landmarks[0]);
                const philtrumRatio = philtrum / faceHeight;

                // --- 텍스트 생성 ---
                let html = "";

                // 초년운
                let earlyLuck = "";
                const r1 = upperFace / faceHeight;
                if (r1 > 0.35) earlyLuck = "이마가 시원하고 넓어 초년운이 아주 좋으며, 학업 성취가 빠르고 부모님의 덕을 볼 상입니다.";
                else if (r1 < 0.30) earlyLuck = "자수성가형 관상입니다. 초년에는 다소 노력이 필요하나 그 경험이 훗날 큰 자산이 됩니다.";
                else earlyLuck = "모나지 않고 평온한 초년을 보낼 상입니다. 큰 어려움 없이 성장이 가능합니다.";
                html += createFortuneItem("초년운 (이마)", earlyLuck, "#98FB98");

                // 중년운
                let midLuck = "";
                const r2 = middleFace / faceHeight;
                if (r2 > 0.34) midLuck = "콧대가 길고 중심이 잡혀있어 중년에 사회적 지위와 명예를 크게 얻을 상입니다.";
                else midLuck = "성실함과 끈기로 중년의 안정을 찾아갑니다. 대기만성형으로 꾸준함이 무기입니다.";
                html += createFortuneItem("중년운 (눈썹~코)", midLuck, "#87CEEB");

                // 말년운
                let lateLuck = "";
                const r3 = lowerFace / faceHeight;
                if (r3 > 0.34) lateLuck = "하관이 발달하여 말년복이 좋고, 리더십이 있어 많은 사람들을 거느릴 상입니다.";
                else lateLuck = "안정을 추구하는 말년입니다. 건강 관리에 유의하면 평온한 노후를 보냅니다.";
                html += createFortuneItem("말년운 (입~턱)", lateLuck, "#DDA0DD");

                // 연애운
                let loveLuck = "";
                if (eyeRatio > 0.3) loveLuck = "눈이 동그랗고 감수성이 풍부하여 다정다감합니다. 이성에게 인기가 많으나 감정에 휩쓸리기 쉽습니다.";
                else loveLuck = "눈매가 그윽하고 신중한 타입입니다. 한 번 마음을 주면 변치 않는 깊은 사랑을 합니다.";
                html += createFortuneItem("연애운 (눈매)", loveLuck, "#FF69B4");

                // 금전운
                let moneyLuck = "";
                if (noseRatio > 0.75) moneyLuck = "재물 창고인 코(준두)가 넉넉하여 돈이 잘 모이고 재복이 따르는 부자 관상입니다.";
                else moneyLuck = "재물보다는 명예나 전문성을 추구하는 학자/예술가 타입입니다. 들어온 돈 관리에 신경 써야 합니다.";
                html += createFortuneItem("금전운 (코)", moneyLuck, "#FFD700");

                // 자식운
                let childLuck = "";
                if (philtrumRatio > 0.04) childLuck = "인중이 깊고 또렷하여 자식복이 좋고, 자녀가 훌륭하게 성장할 기운을 가지고 있습니다.";
                else childLuck = "자녀와의 관계에서 소통이 중요합니다. 엄격함보다는 친구 같은 부모가 되는 것이 좋습니다.";
                html += createFortuneItem("자식운 (인중)", childLuck, "#FFA07A");

                resultsDiv.innerHTML = html;

            }
            canvasCtx.restore();
        }

        function createFortuneItem(title, desc, color) {
            return `
                <div class="fortune-item">
                    <div class="fortune-title" style="color:${color}">${title}</div>
                    <div class="fortune-desc">${desc}</div>
                </div>
            `;
        }

        // MediaPipe FaceMesh 설정
        const faceMesh = new FaceMesh({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
        }});

        faceMesh.setOptions({
            maxNumFaces: 1,
            refineLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        faceMesh.onResults(onResults);

        // 카메라 설정
        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await faceMesh.send({image: videoElement});
            },
            width: 480,
            height: 360
        });

        camera.start();

        // 캔버스 크기 맞춤
        videoElement.addEventListener('loadeddata', () => {
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;
        });

    </script>
</body>
</html>